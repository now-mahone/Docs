@echo off
REM Created: 2026-02-09
REM Kerne Protocol â€” Shannon Pentest Runner (Windows)
REM Usage: run_pentest.bat [frontend|contracts]
REM 
REM Uses Gemini 3 Flash via OpenRouter (Router Mode)
REM Requires: OPENROUTER_API_KEY in shannon\.env

setlocal enabledelayedexpansion

echo ============================================
echo  Kerne Protocol - Shannon AI Pentester
echo  Model: Gemini 3 Flash (via OpenRouter)
echo ============================================
echo.

REM Check Docker is running
docker info >nul 2>&1
if errorlevel 1 (
    echo [ERROR] Docker is not running. Please start Docker Desktop first.
    exit /b 1
)

REM Check for .env file
if not exist "shannon\.env" (
    echo [ERROR] No .env file found in shannon directory.
    echo.
    echo Create one with your OpenRouter API key:
    echo   cd "penetration testing\shannon"
    echo   echo OPENROUTER_API_KEY=your-openrouter-key-here ^> .env
    echo.
    echo Get your key at: https://openrouter.ai/keys
    exit /b 1
)

REM Default target
set TARGET=%1
if "%TARGET%"=="" set TARGET=frontend

REM Prepare repos directory
if not exist "shannon\repos\kerne-protocol" (
    echo [INFO] Preparing Kerne source code for Shannon analysis...
    mkdir "shannon\repos\kerne-protocol" 2>nul
    
    echo [INFO] Copying frontend source...
    xcopy /E /I /Q "..\frontend" "shannon\repos\kerne-protocol\frontend" >nul
    
    echo [INFO] Copying smart contract source...
    xcopy /E /I /Q "..\src" "shannon\repos\kerne-protocol\src" >nul
    
    echo [INFO] Copying bot source...
    xcopy /E /I /Q "..\bot" "shannon\repos\kerne-protocol\bot" >nul
    
    echo [INFO] Copying SDK source...
    xcopy /E /I /Q "..\sdk" "shannon\repos\kerne-protocol\sdk" >nul
    
    echo [INFO] Source code prepared.
)

echo.
echo [INFO] Target: %TARGET%
echo [INFO] Starting Shannon pentest with ROUTER=true (Gemini 3 Flash)...
echo.

cd shannon

if "%TARGET%"=="frontend" (
    echo [INFO] Running frontend pentest against http://host.docker.internal:3000
    echo [WARN] Make sure the frontend is running locally: cd frontend ^&^& npm run dev
    echo.
    .\shannon start URL=http://host.docker.internal:3000 REPO=kerne-protocol CONFIG=./configs/kerne-frontend.yaml OUTPUT=../reports ROUTER=true
) else (
    echo [INFO] Running default pentest against http://host.docker.internal:3000
    .\shannon start URL=http://host.docker.internal:3000 REPO=kerne-protocol OUTPUT=../reports ROUTER=true
)

echo.
echo [INFO] Pentest started. Use these commands to monitor:
echo   cd "penetration testing\shannon"
echo   .\shannon logs
echo   start http://localhost:8233  (Temporal UI)
echo.

endlocal